CREATE DATABASE ascendcargo_cm;
USE ascendcargo_cm;

-- 顶层组织架构
CREATE TABLE Organizations (
  id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(255) NOT NULL,
  legal_name VARCHAR(255),
  tax_id VARCHAR(50),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 合同核心表
CREATE TABLE Contracts (
  id INT PRIMARY KEY AUTO_INCREMENT,
  org_id INT NOT NULL,
  contract_ref VARCHAR(50) UNIQUE,
  status ENUM('draft','active','expired') DEFAULT 'draft',
  effective_date DATE,
  expiration_date DATE,
  FOREIGN KEY (org_id) REFERENCES Organizations(id)
);

-- 运输通道主表
CREATE TABLE Lanes (
  id INT PRIMARY KEY AUTO_INCREMENT,
  contract_id INT NOT NULL,
  name VARCHAR(100),
  description TEXT,
  origin_type ENUM('terminal','warehouse','port'),
  destination_type ENUM('terminal','warehouse','port'),
  FOREIGN KEY (contract_id) REFERENCES Contracts(id)
);

-- 实际运输路线
CREATE TABLE Routes (
  id INT PRIMARY KEY AUTO_INCREMENT,
  lane_id INT NOT NULL,
  mode ENUM('sea','rail','truck','air') NOT NULL,
  carrier_org_id INT NOT NULL,
  equipment_type VARCHAR(50),
  distance DECIMAL(10,2),
  distance_unit ENUM('km','mile'),
  transit_time INT COMMENT 'in hours',
  capacity INT,
  FOREIGN KEY (lane_id) REFERENCES Lanes(id),
  FOREIGN KEY (carrier_org_id) REFERENCES Organizations(id)
);

-- 费率主表（与路线解耦）
CREATE TABLE Rates (
  id INT PRIMARY KEY AUTO_INCREMENT,
  route_id INT NOT NULL,
  basis_type ENUM('flat','percentage','weight','volume') NOT NULL,
  currency CHAR(3) NOT NULL,
  cost DECIMAL(12,4),
  revenue DECIMAL(12,4),
  min_charge DECIMAL(12,2),
  max_charge DECIMAL(12,2),
  effective_date DATE,
  expiration_date DATE,
  FOREIGN KEY (route_id) REFERENCES Routes(id)
);

-- 地理信息系统
CREATE TABLE Locations (
  id INT PRIMARY KEY AUTO_INCREMENT,
  org_id INT COMMENT '所属组织',
  type ENUM('port','terminal','warehouse','customs'),
  code VARCHAR(50) UNIQUE,
  name VARCHAR(255),
  address TEXT,
  city VARCHAR(100),
  state VARCHAR(100),
  country CHAR(2),
  coordinates POINT SRID 4326,
  FOREIGN KEY (org_id) REFERENCES Organizations(id),
  SPATIAL INDEX(coordinates)
);

-- 通道-地点关联
CREATE TABLE Lane_Locations (
  lane_id INT,
  location_id INT,
  type ENUM('origin','destination','via_point'),
  sequence INT,
  PRIMARY KEY (lane_id, location_id, type),
  FOREIGN KEY (lane_id) REFERENCES Lanes(id),
  FOREIGN KEY (location_id) REFERENCES Locations(id)
);

-- 设备主数据
CREATE TABLE Equipment (
  id INT PRIMARY KEY AUTO_INCREMENT,
  type VARCHAR(50) UNIQUE,
  iso_code VARCHAR(10),
  capacity DECIMAL(10,2),
  unit ENUM('TEU','FEU','ton','cbm')
);

-- 合同附属条款
CREATE TABLE Contract_Accessorials (
  id INT PRIMARY KEY AUTO_INCREMENT,
  contract_id INT NOT NULL,
  type ENUM('fuel_surcharge','detention','demurrage'),
  calculation_method TEXT,
  FOREIGN KEY (contract_id) REFERENCES Contracts(id)
);

-- 文档管理
CREATE TABLE Documents (
  id INT PRIMARY KEY AUTO_INCREMENT,
  contract_id INT NOT NULL,
  doc_type VARCHAR(50),
  s3_key VARCHAR(255) UNIQUE,
  created_by INT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (contract_id) REFERENCES Contracts(id)
);